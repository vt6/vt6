<!-- draft -->
# `vt6/core1.0` - Fundamental protocols and interface contracts

The canonical URL for this document is <https://vt6.io/std/core/1.0/>.

**This is a non-normative draft.**

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119](https://tools.ietf.org/html/rfc2119).

This document uses augmented Backus-Naur form (ABNF) as defined in [RFC 5234](https://tools.ietf.org/html/rfc5234).

Unless stated otherwise, this document implies all definitions of terms made by [`vt6/foundation`](https://vt6.io/std/foundation/).

## 1. Scope

This module contains the most basic parts of the VT6 protocol that can be versioned.
The only thing more basic than this is [`vt6/foundation`](https://vt6.io/std/foundation/) which contains the unversionable parts of the VT6 protocol.

## 2. Definitions

### 2.1. Predefined property types

When a property is said to **accept string values**, this means that the set of acceptable values for this property is the set of all byte strings whose value is a properly UTF-8-encoded string.

*Rationale:* [utf8everywhere.org](http://utf8everywhere.org) nicely sums up the arguments for not bothering with other text encodings.

```abnf
integer          = "0" / ( [sign] nzdigit *digit )
unsigned-integer = "0" / ( nzdigit *digit )

sign = "+" / "-"
```

When a property is said to **accept integer values**, this means that the set of acceptable values for this property is the set of all byte strings whose value matches the `<integer>` grammar element defined above.
Analogously, when a property is said to **accept unsigned integer values**, this means that the set of acceptable values for this property is the set of all byte strings whose value matches the `<unsigned-integer>` grammar element defined above.

In both these cases, the **numerical value** of each such byte string is the decimal value of the sequence of digits in the byte string's value, possibly negated by a sign.
The module specification defining the property may impose additional restrictions on the numerical value of the property.

Module specifications which use some or all of the property types defined in this section SHALL reference this section.
The recommended way to do so is by including the following sentence near the start of the specification:

> This document uses the predefined property types from `vt6/core1.0`.

## 3. Message types for `vt6/core1.0`

### 3.1. The `core1.lifetime-end` message

- Role: request (not answered)
- Directionality: both (see below)
- Number of arguments: one

A clients sends a `core1.lifetime-end` message to announce the end of the lifetime of a client ID.
When sending a `core1.lifetime-end` message, the client MUST simultaneously send it in both directions.
It MUST write it into its message input **and** into its message output at the same time.

*Rationale:* This ensures that all proxies, both input proxies and output proxies, observe the end of the lifetime.

The only argument of a `core1.lifetime-end` message SHALL be a client ID.

Upon receiving a `core1.lifetime-end` message, the terminal SHALL consider the lifetime of that client ID ended.
A response SHALL NOT be sent.

### 3.2. The `core1.sub` message

- Role: request (answered by `core1.pub`)
- Directionality: against the current (for properties published by the producer side of the terminal), with the current (for properties published by the consumer side of the terminal)
- Number of arguments: one

A client sends a `core1.sub` message to establish a **subscription** to a property.
The argument SHALL be the name of that property.
A `core1.sub` message is semantically invalid if its argument is not the name of a property.

Upon receiving a valid `core1.sub` message, the terminal MUST record a subscription to the specified property, and immediately notify the sender of the property's current value with a corresponding `core1.pub` response (see below).
Further `core1.pub` responses SHALL be generated whenever the property's value changes.

*Rationale:* It is intentional that subscribing to a property is the only way to retrieve a property's value.
This design nudges implementors towards handling changes to properties properly.

### 3.3. The `core1.pub` message

- Role: response (answers `core1.sub` and `core1.set`)
- Directionality: with the current (for properties published by the producer side of the terminal), against the current (for properties published by the consumer side of the terminal)
- Number of arguments: two

A terminal sends a `core1.pub` message in response to a `core1.sub` or `core1.set` message.
The first argument SHALL be the name of a property.
The second argument SHALL be the value of that property.

A `core1.pub` message is semantically invalid if:

- its first argument is not the name of a property, or
- its second argument is not a valid value for the property in question according to the specification defining the property.

### 3.4. The `core1.set` message

- Role: request (answered by `core1.pub`)
- Directionality: against the current (for properties published by the producer side of the terminal), with the current (for properties published by the consumer side of the terminal)
- Number of arguments: two

A client can send a `core1.set` message to the terminal to request that the value of a property be changed.
The argument list of a `core1.set` message has the same form as that of a `core1.pub` message (a pair of property name and value).

A `core1.set` message is semantically invalid if its first argument is not the name of a property.

The message is *not* semantically invalid if the second argument is a value that is not permissible for the property in question, and the rest of the message is semantically valid.

*Rationale:* For non-trivial properties, the client might not have enough information to decide whether a given value is valid.

A client's request to change the value of a property does not imply any obligation of the terminal to comply with this request.
The terminal may refuse to change the property's value at all (especially if the property is read-only), it may comply with the request, or set the property to an entirely different value, as long as the value is valid according to the property's specification.

The terminal MUST reply with a `core1.pub` message to indicate the new value of the property, regardless of whether the value was changed or not.
The client SHOULD observe the response to learn whether the requested changes were accepted.
